- name: builtin.hls.ts.transcode
  type: TASK
  outputClasses: []
  validation: {}
  task:
    type: EPHEMERAL
#    image: jrottenberg/ffmpeg:4.4-alpine
    image: core.harbor.10.131.36.27.nip.io/oaas/ffmpeg
    commands:
      - /bin/sh
      - '-c'
    containerArgs:
      - |
        CMD="ffmpeg -i $MAIN_RESOURCE_BASE_URL/$REQUEST_FILE -s ${RESOLUTION:-720x480} -c:a copy -method PUT -f mpegts $REQUEST_FILE"
        echo "COMMAND: '$CMD'"
        $CMD
        CMD="curl -T $REQUEST_FILE $OUTPUT_RESOURCE_BASE_URL/$REQUEST_FILE"
        echo "COMMAND: '$CMD'"
        $CMD
    argsToEnv: true

- name: builtin.hls.macro.transcode
  type: MACRO
  outputClasses: []
  validation: {}
  macro:
    steps:
      - funcName: builtin.logical.copy
        target: m3u8
        as: new_m3u8
        inputRefs: []
      - funcName: builtin.hls.ts.transcode
        target: segments
        as: new_segments
        inputRefs: []
    exports:
      - from: new_m3u8
        as: m3u8
      - from: new_segments
        as: segments
